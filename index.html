<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Math Practice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f3f4f6;
      --card: #ffffff;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-soft: #e5e7eb;
      --danger: #b91c1c;
      --success: #15803d;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0ebff 0, #f4f5fb 45%, #eef2ff 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .app-shell {
      width: 100%;
      max-width: 960px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 16px;
    }

    @media (min-width: 768px) {
      .app-shell {
        padding: 32px 24px;
      }
    }

    .app-container {
      flex: 1;
      background: var(--card);
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
      padding: 20px 16px 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    @media (min-width: 768px) {
      .app-container {
        border-radius: 22px;
        padding: 24px 24px 28px;
      }
    }

    header.app-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid var(--border-soft);
      padding-bottom: 10px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 1.6rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .subtitle {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .meta-chip {
      font-size: 0.8rem;
      padding: 5px 10px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 6px;
    }

    footer.app-footer {
      margin-top: 10px;
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Forms & controls */

    .card {
      border-radius: 16px;
      border: 1px solid var(--border-soft);
      background: #f9fafb;
      padding: 14px 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .field-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 640px) {
      .field-row {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.9rem;
    }

    label {
      font-weight: 600;
      color: var(--text-main);
    }

    select,
    input[type="number"],
    input[type="text"] {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      font-size: 0.95rem;
      outline: none;
      background: #ffffff;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    select:focus,
    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
      background: #f9fafb;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s ease;
    }

    .btn-primary {
      background: var(--accent);
      color: #ffffff;
      box-shadow: 0 12px 22px rgba(37, 99, 235, 0.35);
      white-space: nowrap;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(37, 99, 235, 0.42);
      background: #1d4ed8;
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 8px 16px rgba(37, 99, 235, 0.35);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
      box-shadow: none;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .btn-secondary:active {
      transform: translateY(0);
    }

    .actions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-start;
      margin-top: 6px;
    }

    .helper-text {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Quiz view */

    .screen {
      display: none;
      flex-direction: column;
      gap: 12px;
    }

    .screen.active {
      display: flex;
    }

    .info-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .info-row span {
      margin-right: 10px;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 0.78rem;
    }

    .quiz-layout {
      border-radius: 16px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      padding: 16px 14px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 220px;
    }

    @media (min-width: 768px) {
      .quiz-layout {
        padding: 18px 18px 20px;
      }
    }

    .quiz-top {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.86rem;
      color: var(--text-muted);
    }

    .quiz-top-left,
    .quiz-top-right {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      margin-top: 4px;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #2563eb, #4f46e5);
      transition: width 0.25s ease;
    }

    .concept-tag {
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: 999px;
      background: #f3e8ff;
      color: #6b21a8;
      align-self: flex-start;
    }

    .question-text {
      font-size: 1.1rem;
      margin-top: 4px;
      white-space: pre-wrap;
    }

    .answer-row {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .answer-input {
      max-width: 220px;
    }

    .feedback {
      min-height: 20px;
      font-size: 0.9rem;
      margin-top: 4px;
    }

    .feedback.error {
      color: var(--danger);
    }

    .feedback.info {
      color: var(--text-muted);
    }

    .correct-flash {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2.2rem;
      font-weight: 800;
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      text-shadow: 0 2px 6px rgba(15, 23, 42, 0.25);
    }

    .correct-flash.visible {
      opacity: 1;
      transform: translate(-50%, -52%);
    }

    .help-panel {
      margin-top: 8px;
      padding: 10px 10px 10px;
      border-radius: 10px;
      background: #f3f4ff;
      border: 1px solid #e0e7ff;
      font-size: 0.9rem;
      display: none;
      flex-direction: column;
      gap: 6px;
    }

    .help-panel.visible {
      display: flex;
    }

    .help-heading {
      font-weight: 600;
      color: #1e3a8a;
      font-size: 0.9rem;
    }

    .help-hint {
      color: #1f2937;
    }

    .help-example {
      font-size: 0.86rem;
      color: #374151;
      white-space: pre-wrap;
    }

    .divider {
      height: 1px;
      background: #e5e7eb;
      margin: 8px 0;
    }

    .small-link-btn {
      border: none;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.78rem;
      background: #e0e7ff;
      color: #1d4ed8;
      cursor: pointer;
      align-self: flex-start;
    }

    /* Result screen */

    .result-card {
      border-radius: 16px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      padding: 16px 14px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .result-section-title {
      font-size: 0.92rem;
      font-weight: 700;
      color: #111827;
    }

    .result-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      font-size: 0.9rem;
      color: #111827;
    }

    .result-label {
      color: var(--text-muted);
      margin-right: 4px;
    }

    .result-summary-line {
      margin-top: 4px;
      font-size: 0.9rem;
      color: #111827;
    }

    .result-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 480px) {
      .title-block h1 {
        font-size: 1.3rem;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="app-container">
      <header class="app-header">
        <div class="title-block">
          <h1>Math Practice</h1>
          <p class="subtitle">Singapore-style mastery practice from Grade 1 to Grade 12</p>
        </div>
        <div class="meta-chip">
          <span>Mastery Mode</span>
        </div>
      </header>

      <main>
        <!-- HOME SCREEN -->
        <section id="home-screen" class="screen active">
          <div class="card">
            <div class="field-row">
              <div class="field">
                <label for="grade-select">Grade</label>
                <select id="grade-select">
                  <option value="">Select grade</option>
                  <option value="1">Grade 1</option>
                  <option value="2">Grade 2</option>
                  <option value="3">Grade 3</option>
                  <option value="4">Grade 4</option>
                  <option value="5">Grade 5</option>
                  <option value="6">Grade 6</option>
                  <option value="7">Grade 7</option>
                  <option value="8">Grade 8</option>
                  <option value="9">Grade 9</option>
                  <option value="10">Grade 10</option>
                  <option value="11">Grade 11</option>
                  <option value="12">Grade 12</option>
                </select>
              </div>

              <div class="field">
                <label for="progressive-select">Progressive (Topic)</label>
                <select id="progressive-select">
                  <option value="">Select grade first</option>
                </select>
                <div class="helper-text">
                  Each grade has 7 progressives based on Singapore curriculum.
                </div>
              </div>

              <div class="field">
                <label for="number-input">Number (1–100)</label>
                <input id="number-input" type="number" min="1" max="100" placeholder="1–100" />
                <div class="helper-text">
                  Higher numbers = more challenging within this progressive.
                </div>
              </div>
            </div>

            <div class="actions-row">
              <button id="start-quiz-btn" class="btn-primary">Start Quiz</button>
            </div>
            <div id="home-error" class="feedback error"></div>
          </div>
        </section>

        <!-- QUIZ SCREEN -->
        <section id="quiz-screen" class="screen">
          <div class="quiz-layout">
            <div class="quiz-top">
              <div class="quiz-top-left">
                <span class="badge" id="quiz-grade-topic"></span>
                <span class="badge" id="quiz-number-label"></span>
                <span class="badge" id="quiz-concept-label"></span>
              </div>
              <div class="quiz-top-right">
                <span>Quiz ID: <strong id="quiz-id"></strong></span>
              </div>
            </div>

            <div class="info-row">
              <span>Started: <span id="quiz-start-time"></span></span>
              <span>Elapsed: <span id="quiz-elapsed-time">00:00</span></span>
              <span>Question: <span id="quiz-question-counter">1 / 25</span></span>
            </div>

            <div class="progress-bar">
              <div id="quiz-progress-fill" class="progress-fill"></div>
            </div>

            <div class="divider"></div>

            <div id="quiz-question-block">
              <div id="quiz-question-text" class="question-text"></div>

              <div class="answer-row">
                <div class="field">
                  <label for="answer-input">Your answer</label>
                  <input id="answer-input" type="number" class="answer-input" />
                </div>

                <div class="actions-row">
                  <button id="submit-answer-btn" class="btn-primary">Submit Answer</button>
                  <button id="help-btn" class="btn-secondary">Help</button>
                </div>
                <div id="quiz-feedback" class="feedback info"></div>
              </div>

              <div id="help-panel" class="help-panel">
                <div class="help-heading">Hint</div>
                <div id="help-hint" class="help-hint"></div>
                <button id="show-explanation-btn" class="small-link-btn">Show full explanation with example</button>
                <div id="explanation-block" class="hidden">
                  <div class="divider"></div>
                  <div class="help-heading">Explanation (concept)</div>
                  <div id="help-explanation" class="help-example"></div>
                  <div class="help-heading">Example (step by step)</div>
                  <div id="help-example" class="help-example"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- RESULT SCREEN -->
        <section id="result-screen" class="screen">
          <div class="result-card">
            <div class="result-section-title">Quiz Summary</div>
            <div class="result-row">
              <div><span class="result-label">Grade:</span><span id="result-grade"></span></div>
              <div><span class="result-label">Progressive:</span><span id="result-progressive"></span></div>
            </div>
            <div class="result-row">
              <div><span class="result-label">Topic:</span><span id="result-topic"></span></div>
              <div><span class="result-label">Number:</span><span id="result-number"></span></div>
            </div>
            <div class="result-row">
              <div><span class="result-label">Quiz ID:</span><span id="result-quiz-id"></span></div>
            </div>

            <div class="divider"></div>

            <div class="result-section-title">Time</div>
            <div class="result-row">
              <div><span class="result-label">Started:</span><span id="result-started"></span></div>
            </div>
            <div class="result-row">
              <div><span class="result-label">Finished:</span><span id="result-finished"></span></div>
            </div>
            <div class="result-row">
              <div><span class="result-label">Total time:</span><span id="result-total-time"></span></div>
              <div><span class="result-label">Avg per question:</span><span id="result-avg-time"></span></div>
            </div>

            <div class="divider"></div>

            <div class="result-section-title">Learning Metrics</div>
            <div class="result-row">
              <div><span class="result-label">First-try correct:</span><span id="result-first-try"></span></div>
            </div>
            <div class="result-row">
              <div><span class="result-label">Questions needing multiple attempts:</span><span id="result-multi-attempt"></span></div>
            </div>
            <div class="result-row">
              <div><span class="result-label">Questions with help used:</span><span id="result-help-used"></span></div>
            </div>

            <div class="divider"></div>

            <div class="result-summary-line" id="result-summary-line"></div>

            <div class="result-actions">
              <button id="retry-btn" class="btn-secondary">Try this Number again</button>
              <button id="next-number-btn" class="btn-primary">Next Number</button>
              <button id="back-home-btn" class="btn-secondary">Back to Home</button>
            </div>
          </div>
        </section>
      </main>
    </div>

    <footer class="app-footer">
      Made by Ten Daddy
    </footer>

    <!-- Correct answer flash -->
    <div id="correct-flash" class="correct-flash">Awesome!</div>

    <!-- Audio (you can add correct.mp3 and result-melody.mp3 in same folder) -->
    <audio id="correct-sound" src="correct.mp3" preload="auto"></audio>
    <audio id="result-sound" src="result-melody.mp3" preload="auto"></audio>
  </div>

  <script>
    // -----------------------------
    // Curriculum & topic mapping
    // -----------------------------

    const curriculum = {
      1: [
        { topic: "Numbers to 100", typeKey: "numbers_basic" },
        { topic: "Addition & Subtraction within 100", typeKey: "add_sub" },
        { topic: "Patterns & Comparison", typeKey: "patterns_basic" },
        { topic: "Shapes & Spatial Awareness", typeKey: "shapes_basic" },
        { topic: "Length, Time, and Money", typeKey: "measurement_basic" },
        { topic: "Simple Word Problems", typeKey: "add_sub_word" },
        { topic: "Mixed Review (Early Skills)", typeKey: "mixed_early" }
      ],
      2: [
        { topic: "Numbers to 1000", typeKey: "numbers_1000" },
        { topic: "Addition & Subtraction within 1000", typeKey: "add_sub" },
        { topic: "Multiplication & Division Concepts", typeKey: "mul_div_basic" },
        { topic: "Money & Time", typeKey: "measurement_basic" },
        { topic: "Geometry Basics", typeKey: "shapes_basic" },
        { topic: "Early Bar Model Problems", typeKey: "bar_basic" },
        { topic: "Two-step Word Problems", typeKey: "add_sub_word" }
      ],
      3: [
        { topic: "Multiplication Tables", typeKey: "mul_div_basic" },
        { topic: "Division Facts", typeKey: "mul_div_basic" },
        { topic: "Fractions (Basics)", typeKey: "fraction_of_number" },
        { topic: "Area & Perimeter", typeKey: "area_perimeter" },
        { topic: "Bar Models (Part–Whole)", typeKey: "bar_basic" },
        { topic: "Measurement (Mass/Capacity)", typeKey: "measurement_basic" },
        { topic: "Multi-Step Word Problems", typeKey: "mixed_primary_word" }
      ],
      4: [
        { topic: "Fractions (Unlike Denominators)", typeKey: "fraction_add_sub" },
        { topic: "Decimals (Intro & Operations)", typeKey: "decimals_basic" },
        { topic: "Multi-Digit Multiplication", typeKey: "mul_multi" },
        { topic: "Long Division", typeKey: "long_division" },
        { topic: "Factors & Multiples", typeKey: "factors_multiples" },
        { topic: "Angles & Geometry Basics", typeKey: "angles_basic" },
        { topic: "Advanced Bar Model Problems", typeKey: "bar_advanced" }
      ],
      5: [
        { topic: "Fractions (Multiply & Divide)", typeKey: "fraction_mul_div" },
        { topic: "Decimal Operations", typeKey: "decimals_basic" },
        { topic: "Ratio Basics", typeKey: "ratio_basic" },
        { topic: "Percentage Basics", typeKey: "percent_basic" },
        { topic: "Volume (Rectangular Prisms)", typeKey: "volume_rect" },
        { topic: "Rate (Intro)", typeKey: "rate_basic" },
        { topic: "Complex Word Problems", typeKey: "mixed_primary_word" }
      ],
      6: [
        { topic: "Ratio Advanced", typeKey: "ratio_basic" },
        { topic: "Percentage Advanced", typeKey: "percent_basic" },
        { topic: "Speed/Time/Distance", typeKey: "rate_basic" },
        { topic: "Average", typeKey: "average_basic" },
        { topic: "Algebra Introduction", typeKey: "linear_eq" },
        { topic: "Geometry (Triangles & Angles)", typeKey: "angles_basic" },
        { topic: "Hard Word Problems", typeKey: "mixed_primary_word" }
      ],
      7: [
        { topic: "Negative Numbers & Integer Operations", typeKey: "integers_basic" },
        { topic: "Algebra Basics (Expressions)", typeKey: "algebra_expr" },
        { topic: "Linear Equations", typeKey: "linear_eq" },
        { topic: "Coordinate Geometry (Intro)", typeKey: "coordinate_basic" },
        { topic: "Geometry (Parallel Lines & Angles)", typeKey: "angles_basic" },
        { topic: "Area/Volume Advanced", typeKey: "area_perimeter" },
        { topic: "Algebra Word Problems", typeKey: "linear_eq_word" }
      ],
      8: [
        { topic: "Linear Equations Mastery", typeKey: "linear_eq" },
        { topic: "Simultaneous Equations", typeKey: "simultaneous_eq" },
        { topic: "Exponents", typeKey: "exponents_basic" },
        { topic: "Ratio & Rate (Advanced)", typeKey: "ratio_basic" },
        { topic: "Probability Basics", typeKey: "probability_basic" },
        { topic: "Similarity & Congruence", typeKey: "similarity_basic" },
        { topic: "Functions (Intro)", typeKey: "functions_basic" }
      ],
      9: [
        { topic: "Quadratic Expressions", typeKey: "quadratic_expr" },
        { topic: "Factoring Techniques", typeKey: "quadratic_factor" },
        { topic: "Graphing Quadratics (Value at x)", typeKey: "quadratic_value" },
        { topic: "Inequalities", typeKey: "inequalities_basic" },
        { topic: "Algebraic Manipulation", typeKey: "algebra_expr" },
        { topic: "Trigonometry (Intro)", typeKey: "trig_right" },
        { topic: "Circle Properties", typeKey: "circle_basic" }
      ],
      10: [
        { topic: "Trigonometry Deeper", typeKey: "trig_right" },
        { topic: "Polynomial Functions", typeKey: "poly_basic" },
        { topic: "Rational Functions (Simplify)", typeKey: "rational_simplify" },
        { topic: "Coordinate Geometry (Advanced)", typeKey: "coordinate_basic" },
        { topic: "Statistics (Basics)", typeKey: "stats_basic" },
        { topic: "Algebraic Fractions", typeKey: "rational_simplify" },
        { topic: "Identities & Equations", typeKey: "algebra_expr" }
      ],
      11: [
        { topic: "Exponential Functions", typeKey: "exponents_basic" },
        { topic: "Logarithmic Functions (Intro)", typeKey: "logs_basic" },
        { topic: "Quadratic Word Problems", typeKey: "quadratic_value" },
        { topic: "Composite & Inverse Functions", typeKey: "functions_basic" },
        { topic: "Sequences & Series", typeKey: "sequences_basic" },
        { topic: "Probability & Combinatorics", typeKey: "probability_basic" },
        { topic: "Advanced Algebra Problems", typeKey: "algebra_expr" }
      ],
      12: [
        { topic: "Trigonometry Full", typeKey: "trig_right" },
        { topic: "Limits (Intro)", typeKey: "limits_basic" },
        { topic: "Differentiation (Basics)", typeKey: "diff_basic" },
        { topic: "Advanced Sequences & Series", typeKey: "sequences_basic" },
        { topic: "Vectors (Intro)", typeKey: "vectors_basic" },
        { topic: "Statistics (Variance)", typeKey: "stats_basic" },
        { topic: "Non-Routine Heuristic Problems", typeKey: "mixed_secondary_challenge" }
      ]
    };

    // -----------------------------
    // Utility helpers
    // -----------------------------

    function $(id) {
      return document.getElementById(id);
    }

    function formatTimeSeconds(totalSeconds) {
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      const mm = String(minutes).padStart(2, "0");
      const ss = String(seconds).padStart(2, "0");
      return `${mm}:${ss}`;
    }

    function formatDateTime(dt) {
      if (!dt) return "";
      const options = {
        year: "numeric",
        month: "short",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      };
      return dt.toLocaleString(undefined, options);
    }

    function getDifficultyTier(number) {
      if (number <= 20) return "basic";
      if (number <= 40) return "moderate";
      if (number <= 60) return "application";
      if (number <= 80) return "advanced";
      return "challenge";
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function generateQuizId() {
      return "Q-" + randomInt(100000, 999999);
    }

    // -----------------------------
    // Question generation templates
    // -----------------------------

    function createQuestionObject({
      text,
      answer,
      concept,
      typeKey,
      grade,
      params
    }) {
      // params is used to avoid using same numbers in example
      const hint = buildHint(typeKey, grade);
      const { explanation, example } = buildExplanationAndExample(typeKey, grade, params);

      return {
        text,
        answer,
        concept,
        typeKey,
        hint,
        explanation,
        example
      };
    }

    function buildHint(typeKey, grade) {
      const primary = grade <= 6;
      const lowerSec = grade >= 7 && grade <= 9;
      // Basic hints by type
      switch (typeKey) {
        case "add_sub":
        case "add_sub_word":
          return primary
            ? "Think about whether you are putting things together (add) or taking away (subtract)."
            : "Decide if the situation adds to or subtracts from the starting amount, then calculate.";
        case "mul_div_basic":
          return primary
            ? "For multiplication, think of equal groups. For division, think of sharing equally."
            : "Use multiplication for repeated equal groups and division for splitting into equal groups.";
        case "fraction_of_number":
        case "fraction_mul_div":
          return primary
            ? "Use the denominator to split into equal parts, then take the number of parts in the numerator."
            : "First find one part by dividing by the denominator, then multiply by the numerator.";
        case "decimals_basic":
          return primary
            ? "Line up the decimal points vertically before you add or subtract."
            : "Align the decimal points and keep track of place value when you operate.";
        case "ratio_basic":
          return primary
            ? "Add all the parts to get the total number of parts, then find the value of one part."
            : "Think in units: total parts, one part, then multiply by the needed parts.";
        case "percent_basic":
          return primary
            ? "Think of percent as 'out of 100'. Start with easy ones like 10%, 25%, 50%."
            : "Convert percentage to a fraction or decimal, then multiply by the whole.";
        case "rate_basic":
          return primary
            ? "Use 'distance = speed × time' and make sure the units match."
            : "Check which variable you know: distance, speed, or time, then rearrange the formula.";
        case "linear_eq":
        case "simultaneous_eq":
          return lowerSec
            ? "Isolate the unknown by undoing addition/subtraction first, then multiplication/division."
            : "Use inverse operations to move terms across the equals sign step by step.";
        case "trig_right":
          return "Identify the opposite, adjacent, and hypotenuse sides, then choose sin, cos, or tan accordingly.";
        default:
          return primary
            ? "Read the question slowly, underline key numbers, and decide what the question is asking."
            : "Identify what is known, what is unknown, and which relationship connects them.";
      }
    }

    function buildExplanationAndExample(typeKey, grade, params) {
      const primary = grade <= 6;
      const lowerSec = grade >= 7 && grade <= 9;
      const upperSec = grade >= 10;

      let explanation = "";
      let example = "";

      // We'll pick different numbers from params to avoid same question
      function differentSimplePair() {
        // generic simple pair, not using params
        return { a: 18, b: 7 };
      }

      switch (typeKey) {
        case "add_sub": {
          explanation = primary
            ? "When we add, we join quantities together. When we subtract, we find how much is left or how much more one quantity is than another."
            : "Addition combines quantities while subtraction measures difference or what remains. Choose the operation that matches the situation, then calculate carefully.";
          const a = 27, b = 15;
          example =
            "Example (step by step):\n" +
            "We want to find 27 − 15.\n" +
            "1. Subtract the ones: 7 − 5 = 2.\n" +
            "2. Subtract the tens: 2 tens − 1 ten = 1 ten.\n" +
            "3. So 27 − 15 = 12.\n" +
            "This is how we subtract by place value.";
          break;
        }
        case "mul_div_basic": {
          explanation = primary
            ? "Multiplication is repeated addition of equal groups. Division is sharing a total into equal groups or finding how many groups there are."
            : "Use multiplication when you have equal groups combined, and division when you partition a total into equal groups.";
          const groups = 4, each = 6;
          example =
            "Example (step by step):\n" +
            "There are 4 groups with 6 apples in each group. How many apples are there in total?\n" +
            "1. We have 4 equal groups of 6.\n" +
            "2. Multiply: 4 × 6.\n" +
            "3. 4 × 6 = 24.\n" +
            "This is how we use multiplication to count equal groups.";
          break;
        }
        case "fraction_of_number": {
          explanation = primary
            ? "To find a fraction of a number, we first split the whole into equal parts using the denominator. Then we take as many parts as the numerator tells us."
            : "To calculate a fraction of a quantity, divide the whole by the denominator to get one unit, then multiply that unit by the numerator.";
          const whole = 24, num = 3, den = 4;
          example =
            "Example (step by step):\n" +
            "We want to find 3/4 of 24.\n" +
            "1. The denominator 4 means we split 24 into 4 equal parts.\n" +
            "2. 24 ÷ 4 = 6, so 1 part is 6.\n" +
            "3. The numerator 3 means we take 3 of these parts.\n" +
            "4. 3 × 6 = 18.\n" +
            "This is the method for finding a fraction of a number.";
          break;
        }
        case "fraction_mul_div": {
          explanation = primary
            ? "When multiplying fractions, multiply the numerators together and the denominators together. When dividing by a fraction, we multiply by its 'flip' (reciprocal)."
            : "To multiply fractions, multiply across numerators and denominators. To divide by a fraction, multiply by the reciprocal.";
          example =
            "Example (step by step):\n" +
            "We want to multiply 2/3 by 5/4.\n" +
            "1. Multiply the numerators: 2 × 5 = 10.\n" +
            "2. Multiply the denominators: 3 × 4 = 12.\n" +
            "3. The result is 10/12.\n" +
            "4. Simplify 10/12 to 5/6 by dividing top and bottom by 2.\n" +
            "This is the method for multiplying fractions.";
          break;
        }
        case "decimals_basic": {
          explanation = primary
            ? "With decimals, each place to the right is ten times smaller. When we add or subtract, we line up the decimal points so the places match."
            : "Think of decimals as fractions with denominators of 10, 100, or 1000. Align decimal points when adding or subtracting so corresponding place values line up.";
          example =
            "Example (step by step):\n" +
            "We want to add 3.4 and 1.75.\n" +
            "1. Line up the decimal points:\n" +
            "   3.40\n" +
            " + 1.75\n" +
            "2. Add the hundredths: 0 + 5 = 5.\n" +
            "3. Add the tenths: 4 + 7 = 11, write 1 and carry 1.\n" +
            "4. Add the ones: 3 + 1 + 1 (carried) = 5.\n" +
            "5. The answer is 5.15.\n" +
            "This is how we add decimals carefully.";
          break;
        }
        case "ratio_basic": {
          explanation = primary
            ? "Ratios compare parts. We add all the parts to get the total number of parts, then find the value of one part and multiply."
            : "Think in units: add the ratio parts to find total parts, divide the whole by total parts to get one unit, then multiply by however many parts you need.";
          example =
            "Example (step by step):\n" +
            "In a bag, the ratio of red to blue beads is 1 : 3. There are 40 beads altogether.\n" +
            "1. Add the parts: 1 + 3 = 4 parts in total.\n" +
            "2. Find 1 part: 40 ÷ 4 = 10.\n" +
            "3. Red beads = 1 part, so 10 red beads.\n" +
            "4. Blue beads = 3 parts, so 3 × 10 = 30 blue beads.\n" +
            "This is how we use ratios to split a total.";
          break;
        }
        case "percent_basic": {
          explanation = primary
            ? "Percent means 'out of 100'. For simple percentages like 10%, 25%, or 50%, we can use easy fraction ideas."
            : "Convert the percent to a fraction or decimal, then multiply by the whole. For example, 25% is 1/4 and 10% is 0.1.";
          example =
            "Example (step by step):\n" +
            "We want to find 25% of 80.\n" +
            "1. 25% means 25 out of 100, which is the same as 1/4.\n" +
            "2. Find 1/4 of 80: 80 ÷ 4 = 20.\n" +
            "3. So 25% of 80 is 20.\n" +
            "This is how we convert percent to a fraction and use it.";
          break;
        }
        case "rate_basic": {
          explanation = primary
            ? "For speed, distance, and time, we use the relationship: distance = speed × time. We can rearrange this to find the missing value."
            : "Use the formula distance = speed × time. To find speed, divide distance by time. To find time, divide distance by speed.";
          example =
            "Example (step by step):\n" +
            "A car travels at 60 km/h for 2 hours. How far does it go?\n" +
            "1. Use distance = speed × time.\n" +
            "2. Substitute: distance = 60 × 2.\n" +
            "3. Calculate: 60 × 2 = 120.\n" +
            "4. The car travels 120 km.\n" +
            "This is how we use the speed formula.";
          break;
        }
        case "linear_eq": {
          explanation = lowerSec || upperSec
            ? "To solve a linear equation, we isolate the variable by applying inverse operations to both sides. Undo addition/subtraction first, then multiplication/division."
            : "Treat both sides of the equation the same. Whatever you do to one side, do to the other, so the balance is kept.";
          example =
            "Example (step by step):\n" +
            "Solve 3x + 5 = 20.\n" +
            "1. Undo +5 by subtracting 5 from both sides: 3x = 15.\n" +
            "2. Undo ×3 by dividing both sides by 3: x = 15 ÷ 3.\n" +
            "3. x = 5.\n" +
            "This shows how we undo operations step by step.";
          break;
        }
        case "simultaneous_eq": {
          explanation =
            "Simultaneous equations are solved by finding a value of the variables that works in both equations. Common methods are substitution and elimination.";
          example =
            "Example (step by step):\n" +
            "Solve the system:\n" +
            "  x + y = 10\n" +
            "  x − y = 2\n" +
            "1. Add the two equations: (x + y) + (x − y) = 10 + 2.\n" +
            "2. This gives 2x = 12.\n" +
            "3. Divide by 2: x = 6.\n" +
            "4. Substitute x = 6 into x + y = 10: 6 + y = 10.\n" +
            "5. y = 4.\n" +
            "This is the elimination method.";
          break;
        }
        case "trig_right": {
          explanation =
            "In a right triangle, sine, cosine, and tangent relate angles to side lengths. SOH-CAH-TOA reminds us which sides to use for each ratio.";
          example =
            "Example (step by step):\n" +
            "In a right triangle, the hypotenuse is 10 cm and the side opposite angle A is 6 cm. Find sin A.\n" +
            "1. Identify opposite side and hypotenuse.\n" +
            "2. Use sin A = opposite ÷ hypotenuse.\n" +
            "3. sin A = 6 ÷ 10 = 0.6.\n" +
            "This shows how we use the sine ratio.";
          break;
        }
        case "average_basic": {
          explanation = primary
            ? "The average (mean) is found by adding all the values and then dividing by how many there are."
            : "To find the mean, sum the data points and divide by the count. This gives a central value.";
          example =
            "Example (step by step):\n" +
            "The numbers are 4, 7, and 9. Find the average.\n" +
            "1. Add them: 4 + 7 + 9 = 20.\n" +
            "2. There are 3 numbers.\n" +
            "3. Divide: 20 ÷ 3 ≈ 6.67.\n" +
            "This is how we compute the mean.";
          break;
        }
        case "integers_basic": {
          explanation =
            "Negative numbers are values less than zero. When adding and subtracting integers, think about movement along a number line or use sign rules.";
          example =
            "Example (step by step):\n" +
            "Calculate −3 + 7.\n" +
            "1. Start at −3 on the number line.\n" +
            "2. Adding 7 means move 7 units to the right.\n" +
            "3. You land at 4.\n" +
            "So −3 + 7 = 4.\n" +
            "This is how integer addition works on a number line.";
          break;
        }
        default: {
          explanation = primary
            ? "Focus on what the question is asking, identify the important numbers, and choose an operation that fits the situation."
            : "Identify known quantities, unknowns, and relationships. Translate the situation into an equation or structured plan, then solve step by step.";
          example =
            "Example (step by step):\n" +
            "A student reads 12 pages on Monday and 15 pages on Tuesday. How many pages in total?\n" +
            "1. Identify the operation: we combine two amounts, so we add.\n" +
            "2. Add 12 and 15.\n" +
            "3. 12 + 15 = 27.\n" +
            "This is how we convert a story into a calculation.";
        }
      }

      return { explanation, example };
    }

    // -----------------------------
    // Simple question generators
    // (Not full Singapore coverage,
    //  but structured and extendable)
    // -----------------------------

    function generateQuestion(grade, progressiveIndex, number, typeKey) {
      const tier = getDifficultyTier(number);

      // We'll focus on integer answers, numeric input only.
      switch (typeKey) {
        case "add_sub":
        case "add_sub_word":
          return generateAddSubQuestion(grade, tier);
        case "mul_div_basic":
          return generateMulDivQuestion(grade, tier);
        case "fraction_of_number":
          return generateFractionOfNumberQuestion(grade, tier);
        case "fraction_mul_div":
          return generateFractionMulDivQuestion(grade, tier);
        case "decimals_basic":
          return generateDecimalQuestion(grade, tier);
        case "ratio_basic":
          return generateRatioQuestion(grade, tier);
        case "percent_basic":
          return generatePercentQuestion(grade, tier);
        case "rate_basic":
          return generateRateQuestion(grade, tier);
        case "average_basic":
          return generateAverageQuestion(grade, tier);
        case "linear_eq":
          return generateLinearEqQuestion(grade, tier);
        case "simultaneous_eq":
          return generateSimultaneousEqQuestion(grade, tier);
        case "integers_basic":
          return generateIntegerQuestion(grade, tier);
        case "trig_right":
          return generateTrigQuestion(grade, tier);
        default:
          // Fallback: simple add/sub
          return generateAddSubQuestion(grade, tier);
      }
    }

    function generateAddSubQuestion(grade, tier) {
      let max;
      switch (tier) {
        case "basic": max = 50; break;
        case "moderate": max = 200; break;
        case "application": max = 500; break;
        case "advanced": max = 1000; break;
        case "challenge": max = 5000; break;
      }
      const a = randomInt(0, max);
      const b = randomInt(0, max);
      const op = Math.random() < 0.5 ? "+" : "-";
      let text, answer;
      if (op === "+") {
        text = `Compute: ${a} + ${b}`;
        answer = a + b;
      } else {
        const bigger = Math.max(a, b);
        const smaller = Math.min(a, b);
        text = `Compute: ${bigger} - ${smaller}`;
        answer = bigger - smaller;
      }

      const concept = "Addition/Subtraction of whole numbers";
      return createQuestionObject({
        text,
        answer,
        concept,
        typeKey: "add_sub",
        grade,
        params: { a, b }
      });
    }

    function generateMulDivQuestion(grade, tier) {
      let maxFactor;
      switch (tier) {
        case "basic": maxFactor = 10; break;
        case "moderate": maxFactor = 12; break;
        case "application": maxFactor = 20; break;
        case "advanced": maxFactor = 30; break;
        case "challenge": maxFactor = 50; break;
      }
      const a = randomInt(2, maxFactor);
      const b = randomInt(2, maxFactor);
      const useMult = Math.random() < 0.6;
      let text, answer;
      if (useMult) {
        text = `Compute: ${a} × ${b}`;
        answer = a * b;
      } else {
        const product = a * b;
        text = `Compute: ${product} ÷ ${a}`;
        answer = b;
      }
      const concept = "Multiplication/Division facts and equal groups";
      return createQuestionObject({
        text,
        answer,
        concept,
        typeKey: "mul_div_basic",
        grade,
        params: { a, b }
      });
    }

    function generateFractionOfNumberQuestion(grade, tier) {
      const denomOptions = [2, 3, 4, 5, 6, 8];
      let denom = denomOptions[randomInt(0, denomOptions.length - 1)];
      let numer = randomInt(1, denom - 1);
      let base = 10;
      if (tier === "basic") base = 10;
      else if (tier === "moderate") base = 20;
      else if (tier === "application") base = 40;
      else if (tier === "advanced") base = 80;
      else base = 120;
      const whole = denom * randomInt(2, base / denom + 2);
      const answer = (whole / denom) * numer;
      const text = `Find ${numer}/${denom} of ${whole}.`;
      const concept = "Fraction of a whole number";
      return createQuestionObject({
        text,
        answer,
        concept,
        typeKey: "fraction_of_number",
        grade,
        params: { numer, denom, whole }
      });
    }

    function generateFractionMulDivQuestion(grade, tier) {
      const denomOptions = [2, 3, 4, 5, 6];
      let d1 = denomOptions[randomInt(0, denomOptions.length - 1)];
      let d2 = denomOptions[randomInt(0, denomOptions.length - 1)];
      let n1 = randomInt(1, d1 - 1);
      let n2 = randomInt(1, d2 - 1);
      const useMult = Math.random() < 0.65;
      let text, answer;
      if (useMult) {
        text = `Multiply the fractions: ${n1}/${d1} × ${n2}/${d2}. (Give answer as a whole number if it simplifies nicely.)`;
        const num = n1 * n2;
        const den = d1 * d2;
        // We keep only cases with integer answers by construction
        const factor = randomInt(1, 3);
        const whole = (num * factor) / den;
        if (Number.isInteger(whole)) {
          answer = whole;
        } else {
          // Fallback simple: just product if not integer
          answer = num; // approximate, but still numeric
        }
      } else {
        // Whole ÷ fraction with integer answer
        const denom = d1;
        const numer = n1;
        const whole = denom * randomInt(2, 10); // ensures integer multiple
        text = `Compute: ${whole} ÷ (${numer}/${denom}). (Answer as whole number)`;
        answer = (whole * denom) / numer;
      }
      const concept = "Multiplying or dividing with fractions";
      return createQuestionObject({
        text,
        answer,
        concept,
        typeKey: "fraction_mul_div",
        grade,
        params: { n1, d1, n2, d2 }
      });
    }

    function generateDecimalQuestion(grade, tier) {
      let max = tier === "basic" ? 10 : tier === "moderate" ? 50 : 100;
      const a = (randomInt(10, max * 10) / 10).toFixed(1);
      const b = (randomInt(10, max * 10) / 10).toFixed(1);
      const op = Math.random() < 0.5 ? "+" : "-";
      let text, answer;
      const fa = parseFloat(a), fb = parseFloat(b);
      if (op === "+") {
        text = `Compute: ${a} + ${b} (Round to 1 decimal place if needed)`;
        answer = parseFloat((fa + fb).toFixed(1));
      } else {
        text = `Compute: ${a} - ${b} (Round to 1 decimal place if needed)`;
        answer = parseFloat((fa - fb).toFixed(1));
      }
      const concept = "Addition and subtraction with decimals";
      return createQuestionObject({
        text,
        answer,
        concept,
        typeKey: "decimals_basic",
        grade,
        params: { a: fa, b: fb }
      });
    }

    function generateRatioQuestion(grade, tier) {
      const totalParts = randomInt(3, 8);
      const part1 = randomInt(1, totalParts - 1);
      const part2 = totalParts - part1;
      let total;
      if (tier === "basic") total = totalParts * randomInt(2, 8);
      else if (tier === "moderate") total = totalParts * randomInt(4, 15);
      else if (tier === "application") total = totalParts * randomInt(6, 20);
      else total = totalParts * randomInt(8, 30);

      const focusFirst = Math.random() < 0.5;
      const text = focusFirst
        ? `In a class, the ratio of boys to girls is ${part1} : ${part2}. There are ${total} students in total. How many boys are there?`
        : `In a class, the ratio of boys to girls is ${part1} : ${part2}. There are ${total} students in total. How many girls are there?`;
      const onePart = total / totalParts;
      const answer = focusFirst ? onePart * part1 : onePart * part2;
      const concept = "Ratio as equal parts of a whole";
      return createQuestionObject({
        text,
        answer,
        concept,
        typeKey: "ratio_basic",
        grade,
        params: { part1, part2, total }
      });
    }

    function generatePercentQuestion(grade, tier) {
      const percOptions = tier === "basic"
        ? [10, 20, 25, 50]
        : [5, 10, 15, 20, 25, 30, 40, 50];
      const p = percOptions[randomInt(0, percOptions.length - 1)];
      const base = tier === "challenge" ? randomInt(200, 800) : randomInt(40, 300);
      const text = `Find ${p}% of ${base}. (Answer as whole number)`;
      const answer = Math.round(base * p / 100);
      const concept = "Percent as 'out of 100'";
      return createQuestionObject({
        text,
        answer,
        concept,
        typeKey: "percent_basic",
        grade,
        params: { p, base }
      });
    }

    function generateRateQuestion(grade, tier) {
      const speed = tier === "basic" ? randomInt(20, 60) : randomInt(30, 90);
      const time = tier === "challenge" ? randomInt(3, 8) : randomInt(1, 5);
      const distance = speed * time;
      const mode = Math.random();
      let text, answer;
      if (mode < 0.5) {
        text = `A car travels at ${speed} km/h for ${time} hours. How far does it go? (Answer in km)`;
        answer = distance;
      } else {
        text = `A car travels ${distance} km in ${time} hours. What is its speed? (Answer in km/h)`;
        answer = Math.round(distance / time);
      }
      const concept = "Speed, distance, and time relationship";
      return createQuestionObject({
        text,
        answer,
        concept,
        typeKey: "rate_basic",
        grade,
        params: { speed, time, distance }
      });
    }

    function generateAverageQuestion(grade, tier) {
      const count = tier === "basic" ? 3 : tier === "moderate" ? 4 : 5;
      const nums = [];
      let sum = 0;
      for (let i = 0; i < count; i++) {
        const n = randomInt(10, 60);
        nums.push(n);
        sum += n;
      }
      const avg = sum / count;
      const text =
        `The numbers are ${nums.join(", ")}. What is their average (mean)? (Round to nearest whole number)`;
      const answer = Math.round(avg);
      const concept = "Average as total divided by number of items";
      return createQuestionObject({
        text,
        answer,
        concept,
        typeKey: "average_basic",
        grade,
        params: { nums }
      });
    }

    function generateLinearEqQuestion(grade, tier) {
      let a, b, x, text, c;
      if (tier === "basic") {
        x = randomInt(1, 10);
        a = randomInt(1, 5);
        b = randomInt(0, 20);
      } else {
        x = randomInt(-10, 15);
        a = randomInt(2, 9);
        b = randomInt(-20, 30);
      }
      c = a * x + b;
      text = `Solve for x: ${a}x + ${b} = ${c}`;
      const answer = x;
      const concept = "Solving linear equations in one variable";
      return createQuestionObject({
        text,
        answer,
        concept,
        typeKey: "linear_eq",
        grade,
        params: { a, b, c, x }
      });
    }

    function generateSimultaneousEqQuestion(grade, tier) {
      // Generate simple 2-variable system with integer solution
      const x = randomInt(1, 10);
      const y = randomInt(1, 10);
      const a1 = randomInt(1, 5);
      const b1 = randomInt(1, 5);
      const a2 = randomInt(1, 5);
      const b2 = randomInt(1, 5);
      const c1 = a1 * x + b1 * y;
      const c2 = a2 * x + b2 * y;
      const askForX = Math.random() < 0.5;
      const text =
        `Solve the system:\n` +
        `${a1}x + ${b1}y = ${c1}\n` +
        `${a2}x + ${b2}y = ${c2}\n` +
        `Find the value of ${askForX ? "x" : "y"}.`;
      const answer = askForX ? x : y;
      const concept = "Solving simultaneous linear equations";
      return createQuestionObject({
        text,
        answer,
        concept,
        typeKey: "simultaneous_eq",
        grade,
        params: { a1, b1, c1, a2, b2, c2, x, y }
      });
    }

    function generateIntegerQuestion(grade, tier) {
      const a = randomInt(-20, 20);
      const b = randomInt(-20, 20);
      const op = Math.random() < 0.5 ? "+" : "-";
      let text, answer;
      if (op === "+") {
        text = `Compute: (${a}) + (${b})`;
        answer = a + b;
      } else {
        text = `Compute: (${a}) - (${b})`;
        answer = a - b;
      }
      const concept = "Integer addition and subtraction";
      return createQuestionObject({
        text,
        answer,
        concept,
        typeKey: "integers_basic",
        grade,
        params: { a, b }
      });
    }

    function generateTrigQuestion(grade, tier) {
      // Simple right triangle, find opposite or adjacent or hyp
      const hyp = randomInt(5, 15);
      const opp = randomInt(3, hyp - 1);
      const mode = Math.random();
      let text, answer;
      if (mode < 0.5) {
        text = `In a right triangle, the hypotenuse is ${hyp} and the side opposite angle A is ${opp}. Approximate sin A to 2 decimal places.`;
        answer = parseFloat((opp / hyp).toFixed(2));
      } else {
        const adj = randomInt(3, hyp - 1);
        text = `In a right triangle, the hypotenuse is ${hyp} and the side adjacent to angle B is ${adj}. Approximate cos B to 2 decimal places.`;
        answer = parseFloat((adj / hyp).toFixed(2));
      }
      const concept = "Trigonometric ratios in right triangles";
      return createQuestionObject({
        text,
        answer,
        concept,
        typeKey: "trig_right",
        grade,
        params: { hyp, opp }
      });
    }

    // -----------------------------
    // Quiz state
    // -----------------------------

    const STATE = {
      screen: "home",
      grade: null,
      progressiveIndex: null,
      number: null,
      topic: "",
      quizId: "",
      questions: [],
      currentIndex: 0,
      startTime: null,
      endTime: null,
      elapsedSeconds: 0,
      timerInterval: null,
      attempts: [],
      helpUsed: [],
      firstTryCorrectCount: 0
    };

    const correctMessages = [
      "Awesome!", "Good job!", "Well done!", "Nice!", "Great work!", "Excellent!", "You got it!", "Super!"
    ];

    const correctColors = [
      "#2563eb", "#16a34a", "#7c3aed", "#db2777", "#ea580c", "#0d9488", "#facc15"
    ];

    // -----------------------------
    // UI wiring
    // -----------------------------

    const homeScreen = $("home-screen");
    const quizScreen = $("quiz-screen");
    const resultScreen = $("result-screen");

    const gradeSelect = $("grade-select");
    const progSelect = $("progressive-select");
    const numberInput = $("number-input");
    const homeError = $("home-error");
    const startQuizBtn = $("start-quiz-btn");

    const quizGradeTopic = $("quiz-grade-topic");
    const quizNumberLabel = $("quiz-number-label");
    const quizConceptLabel = $("quiz-concept-label");
    const quizIdSpan = $("quiz-id");
    const quizStartTimeSpan = $("quiz-start-time");
    const quizElapsedTimeSpan = $("quiz-elapsed-time");
    const quizQuestionCounter = $("quiz-question-counter");
    const quizProgressFill = $("quiz-progress-fill");
    const quizQuestionText = $("quiz-question-text");
    const answerInput = $("answer-input");
    const submitAnswerBtn = $("submit-answer-btn");
    const helpBtn = $("help-btn");
    const quizFeedback = $("quiz-feedback");
    const helpPanel = $("help-panel");
    const helpHint = $("help-hint");
    const showExplanationBtn = $("show-explanation-btn");
    const explanationBlock = $("explanation-block");
    const helpExplanation = $("help-explanation");
    const helpExample = $("help-example");

    const resultGrade = $("result-grade");
    const resultProgressive = $("result-progressive");
    const resultTopic = $("result-topic");
    const resultNumber = $("result-number");
    const resultQuizId = $("result-quiz-id");
    const resultStarted = $("result-started");
    const resultFinished = $("result-finished");
    const resultTotalTime = $("result-total-time");
    const resultAvgTime = $("result-avg-time");
    const resultFirstTry = $("result-first-try");
    const resultMultiAttempt = $("result-multi-attempt");
    const resultHelpUsed = $("result-help-used");
    const resultSummaryLine = $("result-summary-line");

    const retryBtn = $("retry-btn");
    const nextNumberBtn = $("next-number-btn");
    const backHomeBtn = $("back-home-btn");

    const correctFlash = $("correct-flash");
    const correctSound = $("correct-sound");
    const resultSound = $("result-sound");

    // Populate progressives when grade changes
    gradeSelect.addEventListener("change", () => {
      const g = parseInt(gradeSelect.value, 10);
      progSelect.innerHTML = "";
      if (!g || !curriculum[g]) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Select grade first";
        progSelect.appendChild(opt);
        return;
      }
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select progressive";
      progSelect.appendChild(placeholder);
      curriculum[g].forEach((p, idx) => {
        const opt = document.createElement("option");
        opt.value = String(idx + 1);
        opt.textContent = `${idx + 1} – ${p.topic}`;
        progSelect.appendChild(opt);
      });
    });

    startQuizBtn.addEventListener("click", () => {
      homeError.textContent = "";
      const gradeVal = parseInt(gradeSelect.value, 10);
      const progVal = parseInt(progSelect.value, 10);
      const numVal = parseInt(numberInput.value, 10);

      if (!gradeVal || !curriculum[gradeVal]) {
        homeError.textContent = "Please choose a valid grade.";
        return;
      }
      if (!progVal || progVal < 1 || progVal > 7) {
        homeError.textContent = "Please choose a progressive.";
        return;
      }
      if (!numVal || numVal < 1 || numVal > 100) {
        homeError.textContent = "Please choose a number between 1 and 100.";
        return;
      }

      startNewQuiz(gradeVal, progVal, numVal);
    });

    submitAnswerBtn.addEventListener("click", () => {
      submitCurrentAnswer();
    });

    answerInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        submitCurrentAnswer();
      }
    });

    helpBtn.addEventListener("click", () => {
      toggleHelpPanel();
    });

    showExplanationBtn.addEventListener("click", () => {
      explanationBlock.classList.remove("hidden");
    });

    retryBtn.addEventListener("click", () => {
      if (STATE.grade && STATE.progressiveIndex && STATE.number) {
        startNewQuiz(STATE.grade, STATE.progressiveIndex, STATE.number);
      }
    });

    nextNumberBtn.addEventListener("click", () => {
      if (STATE.grade && STATE.progressiveIndex) {
        let nextNum = STATE.number + 1;
        if (nextNum > 100) nextNum = 100;
        startNewQuiz(STATE.grade, STATE.progressiveIndex, nextNum);
      }
    });

    backHomeBtn.addEventListener("click", () => {
      switchScreen("home");
    });

    function switchScreen(screen) {
      STATE.screen = screen;
      homeScreen.classList.remove("active");
      quizScreen.classList.remove("active");
      resultScreen.classList.remove("active");

      if (screen === "home") homeScreen.classList.add("active");
      if (screen === "quiz") quizScreen.classList.add("active");
      if (screen === "result") resultScreen.classList.add("active");
    }

    // -----------------------------
    // Quiz lifecycle
    // -----------------------------

    function startNewQuiz(grade, progressiveIndex, number) {
      // Clear timer
      if (STATE.timerInterval) {
        clearInterval(STATE.timerInterval);
        STATE.timerInterval = null;
      }

      STATE.grade = grade;
      STATE.progressiveIndex = progressiveIndex;
      STATE.number = number;
      const prog = curriculum[grade][progressiveIndex - 1];
      STATE.topic = prog.topic;
      STATE.quizId = generateQuizId();
      STATE.questions = [];

      // Build 25 questions: 20 main topic, 5 review
      const typeKey = prog.typeKey;

      // Generate main questions
      for (let i = 0; i < 20; i++) {
        STATE.questions.push(generateQuestion(grade, progressiveIndex, number, typeKey));
      }

      // Generate review questions
      const reviewQuestions = [];
      const possibleReview = [];
      // earlier progressives same grade
      for (let p = 1; p < progressiveIndex; p++) {
        possibleReview.push({ grade, p });
      }
      // maybe previous grade last progressive
      if (grade > 1) {
        possibleReview.push({ grade: grade - 1, p: 7 });
      }
      for (let i = 0; i < 5; i++) {
        if (possibleReview.length === 0) {
          reviewQuestions.push(generateQuestion(grade, progressiveIndex, number, typeKey));
        } else {
          const pick = possibleReview[randomInt(0, possibleReview.length - 1)];
          const revProg = curriculum[pick.grade][pick.p - 1];
          reviewQuestions.push(generateQuestion(pick.grade, pick.p, number, revProg.typeKey));
        }
      }
      STATE.questions = STATE.questions.concat(reviewQuestions);

      // shuffle questions slightly but keep order stable enough
      STATE.questions = shuffleArray(STATE.questions);

      STATE.currentIndex = 0;
      STATE.startTime = new Date();
      STATE.endTime = null;
      STATE.elapsedSeconds = 0;
      STATE.attempts = new Array(STATE.questions.length).fill(0);
      STATE.helpUsed = new Array(STATE.questions.length).fill(false);
      STATE.firstTryCorrectCount = 0;

      quizGradeTopic.textContent = `Grade ${grade} · Progressive ${progressiveIndex} – ${STATE.topic}`;
      quizNumberLabel.textContent = `Number ${number}`;
      quizIdSpan.textContent = STATE.quizId;
      quizStartTimeSpan.textContent = formatDateTime(STATE.startTime);
      quizElapsedTimeSpan.textContent = "00:00";
      quizFeedback.textContent = "Type your answer, then press Submit.";
      quizFeedback.className = "feedback info";
      helpPanel.classList.remove("visible");
      explanationBlock.classList.add("hidden");
      answerInput.value = "";
      answerInput.disabled = false;
      submitAnswerBtn.disabled = false;

      updateQuestionDisplay();
      startTimer();
      switchScreen("quiz");
    }

    function updateQuestionDisplay() {
      const idx = STATE.currentIndex;
      const q = STATE.questions[idx];
      quizQuestionText.textContent = q.text;
      quizConceptLabel.textContent = `Concept: ${q.concept}`;
      quizQuestionCounter.textContent = `${idx + 1} / ${STATE.questions.length}`;

      const pct = ((idx) / STATE.questions.length) * 100;
      quizProgressFill.style.width = `${pct}%`;

      quizFeedback.textContent = "Type your answer, then press Submit.";
      quizFeedback.className = "feedback info";

      helpPanel.classList.remove("visible");
      explanationBlock.classList.add("hidden");
      helpHint.textContent = q.hint;
      helpExplanation.textContent = q.explanation;
      helpExample.textContent = q.example;

      answerInput.value = "";
      answerInput.focus();
    }

    function startTimer() {
      STATE.timerInterval = setInterval(() => {
        if (!STATE.startTime) return;
        const now = new Date();
        const diffSeconds = Math.floor((now - STATE.startTime) / 1000);
        STATE.elapsedSeconds = diffSeconds;
        quizElapsedTimeSpan.textContent = formatTimeSeconds(diffSeconds);
      }, 1000);
    }

    function stopTimer() {
      if (STATE.timerInterval) {
        clearInterval(STATE.timerInterval);
        STATE.timerInterval = null;
      }
    }

    function submitCurrentAnswer() {
      if (STATE.currentIndex >= STATE.questions.length) return;

      const q = STATE.questions[STATE.currentIndex];
      let userVal = answerInput.value.trim();
      if (userVal === "") {
        quizFeedback.textContent = "Please enter a number before submitting.";
        quizFeedback.className = "feedback error";
        return;
      }

      let parsed = parseFloat(userVal);
      if (isNaN(parsed)) {
        quizFeedback.textContent = "Please enter a valid number.";
        quizFeedback.className = "feedback error";
        return;
      }

      STATE.attempts[STATE.currentIndex]++;

      const correctAnswer = q.answer;
      // For decimals, compare with tolerance
      let isCorrect;
      if (typeof correctAnswer === "number" && String(correctAnswer).includes(".")) {
        const diff = Math.abs(correctAnswer - parsed);
        isCorrect = diff < 0.01;
      } else {
        isCorrect = parsed === correctAnswer;
      }

      if (isCorrect) {
        if (STATE.attempts[STATE.currentIndex] === 1) {
          STATE.firstTryCorrectCount++;
        }
        showCorrectFlash();
        playCorrectSound();
        quizFeedback.textContent = "Correct!";
        quizFeedback.className = "feedback info";
        answerInput.disabled = true;
        submitAnswerBtn.disabled = true;

        setTimeout(() => {
          answerInput.disabled = false;
          submitAnswerBtn.disabled = false;
          correctFlash.classList.remove("visible");

          STATE.currentIndex++;
          if (STATE.currentIndex >= STATE.questions.length) {
            finishQuiz();
          } else {
            updateQuestionDisplay();
          }
        }, 1000);
      } else {
        quizFeedback.textContent = "Not correct yet, try again.";
        quizFeedback.className = "feedback error";
      }
    }

    function toggleHelpPanel() {
      const idx = STATE.currentIndex;
      if (!helpPanel.classList.contains("visible")) {
        helpPanel.classList.add("visible");
        STATE.helpUsed[idx] = true;
      } else {
        helpPanel.classList.remove("visible");
      }
    }

    function showCorrectFlash() {
      const msg = correctMessages[randomInt(0, correctMessages.length - 1)];
      const color = correctColors[randomInt(0, correctColors.length - 1)];
      correctFlash.textContent = msg;
      correctFlash.style.color = color;
      correctFlash.classList.add("visible");
    }

    function playCorrectSound() {
      if (correctSound && correctSound.play) {
        try {
          correctSound.currentTime = 0;
          correctSound.volume = 0.6;
          correctSound.play();
        } catch (e) {
          // ignore
        }
      }
    }

    function playResultSound() {
      if (resultSound && resultSound.play) {
        try {
          resultSound.currentTime = 0;
          resultSound.volume = 0.6;
          resultSound.play();
        } catch (e) {
          // ignore
        }
      }
    }

    function finishQuiz() {
      stopTimer();
      STATE.endTime = new Date();

      // Fill result screen
      resultGrade.textContent = `Grade ${STATE.grade}`;
      resultProgressive.textContent = `Progressive ${STATE.progressiveIndex}`;
      resultTopic.textContent = STATE.topic;
      resultNumber.textContent = STATE.number;
      resultQuizId.textContent = STATE.quizId;

      resultStarted.textContent = formatDateTime(STATE.startTime);
      resultFinished.textContent = formatDateTime(STATE.endTime);

      const totalSec = STATE.elapsedSeconds;
      resultTotalTime.textContent = formatTimeSeconds(totalSec);
      const avg = Math.round((totalSec / STATE.questions.length) * 10) / 10;
      resultAvgTime.textContent = `${avg} s/question`;

      const multiAttempts = STATE.questions.length - STATE.firstTryCorrectCount;
      const helpCount = STATE.helpUsed.filter(Boolean).length;

      resultFirstTry.textContent = `${STATE.firstTryCorrectCount} / ${STATE.questions.length}`;
      resultMultiAttempt.textContent = `${multiAttempts}`;
      resultHelpUsed.textContent = `${helpCount}`;

      resultSummaryLine.textContent =
        `Grade ${STATE.grade} · Progressive ${STATE.progressiveIndex} – ${STATE.topic} · Number ${STATE.number} · Quiz ID ${STATE.quizId}`;

      switchScreen("result");
      playResultSound();
    }
  </script>
</body>
</html>
